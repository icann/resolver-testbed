---
- name: Per software configuration tasks.
  delegate_to: "{{ on_host }}"
  vars:
    this_source_dir: "{{ BUILD_SOURCE_DIR }}/{{ software_name }}"
    this_target_dir: "{{ BUILD_TARGET_DIR }}/{{ software_name }}"
  block:
  - name: Check if we already built the source.
    ansible.builtin.stat:
      path: "{{ this_target_dir }}/.compiled.this"
    register: software_compiled

  - name: Configure compiled software
    when: software_compiled.stat.exists
    block:
    - name: Configure BIND
      when: software_sname == 'bind'
      block:
      - name: Start {{ software_name }}
        ansible.builtin.service:
          name: "{{ service_name }}"
          state: started
        vars:
          service_name: "{{ software_name | replace('-', '') | replace ('.', '') }}"

    - name: Configure Unbound
      when: software_sname == 'unbound'
      block: 
      - name: Is resolver started?
        ansible.builtin.stat:
          path: "{{ this_target_dir }}/etc/unbound/unbound.pid"
        register: unbound_pid
    
      - name: Start resolver (if not running)
        ansible.builtin.shell:
          cmd: "PATH={{ this_target_dir }}/bin:{{ this_target_dir }}/sbin:$PATH unbound-control start"
          chdir: "{{ this_target_dir }}"
        when: not unbound_pid.stat.exists
